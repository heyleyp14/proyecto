<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Cliente - Stilyng NR</title>

    <link rel="stylesheet" th:href="@{/css/dashboard-cliente.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Imperial+Script&display=swap" rel="stylesheet">
</head>
<body>

<header class="topbar">
    <div class="logo">
        <img th:src="@{/img/logo.png}" alt="Logo Stilyng NR">
    </div>

    <div class="menu-usuario">
        <button id="btnMenuUsuario" class="menu-toggle">
            <i class="fa-solid fa-bars"></i>
        </button>

        <div class="menu-dropdown" id="menuDropdown">
            <ul>
                <li><a href="#">Mi perfil</a></li>
                <li><a href="#">Configuración</a></li>
                <li>
                    <a href="/logout" id="logout-btn">
                        <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
                    </a>
                </li>
            </ul>
        </div>
    </div>
</header>

<main class="content">

    <!-- FORMULARIO PARA AGENDAR CITA -->
    <section class="agendar-section">
        <h2>Agendar una cita</h2>

        <form id="formCita">

            <div class="form-group">
                <label for="servicio">Servicio</label>
                <select id="servicio" name="servicio" required>
                    <option value="">Cargando servicios...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="fecha">Fecha</label>
                <input type="date" id="fecha" name="fecha" required>
            </div>

            <div class="form-group">
                <label for="hora">Hora</label>
                <input type="time" id="hora" name="hora" required>
            </div>

            <button type="submit" class="btn-agendar">Guardar</button>
        </form>
    </section>

    <!-- TABLA DE CITAS -->
    <section class="tabla-section">
        <h2>Mis citas</h2>

        <table id="tablaCitas">
            <thead>
            <tr>
                <th>Servicio</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

</main>


<!-- SCRIPT: CARGAR SERVICIOS -->
<script>
async function cargarServicios() {
    const select = document.getElementById("servicio");

    try {
        const resp = await fetch("/api/servicios");
        const servicios = await resp.json();

        select.innerHTML = '<option value="">Seleccione un servicio</option>';

        servicios.forEach(s => {
            select.innerHTML += `
                <option value="${s.id}">${s.nombre}</option>
            `;
        });

    } catch (error) {
        select.innerHTML = '<option value="">Error al cargar servicios</option>';
        console.error("Error cargando servicios:", error);
    }
}
cargarServicios();
</script>


<!-- SCRIPT: AGENDAR CITA -->
<script>
document.getElementById("formCita").addEventListener("submit", async function(e) {
    e.preventDefault();

    const cita = {
        fecha: document.getElementById("fecha").value,
        hora: document.getElementById("hora").value,
        servicio: document.getElementById("servicio").value
    };

    try {
        const resp = await fetch("/api/citas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cita)
        });

        if (!resp.ok) {
            alert("Error guardando cita");
            return;
        }

        alert("Cita registrada con éxito");
        document.getElementById("formCita").reset();
        cargarCitas();

    } catch (err) {
        alert("No se pudo conectar con el servidor");
        console.error(err);
    }
});
</script>


<!-- SCRIPT: LISTAR CITAS DEL USUARIO -->
<script>
async function cargarCitas() {
    const tablaBody = document.querySelector("#tablaCitas tbody");

    try {
        const resp = await fetch("/api/citas/cliente");
        const citas = await resp.json();

        tablaBody.innerHTML = "";

        if (citas.length === 0) {
            tablaBody.innerHTML = `
                <tr><td colspan="5" style="text-align:center;color:#777;">No tienes citas registradas</td></tr>
            `;
            return;
        }

        citas.forEach(c => {
            tablaBody.innerHTML += `
                <tr>
                    <td>${c.servicio.nombre}</td>
                    <td>${c.fecha}</td>
                    <td>${c.horaInicio}</td>

                       <td>${estadoTextoCliente(c.estado)}</td>
                    <td>
                         ${
                    c.estado === "REGISTRADA"
                        ? `<button onclick="cancelarCita(${c.id})" class="btn-cancelar">Cancelar</button>`
                        : "<span style='color:#999;'>—</span>"
                }
                    </td>

                </tr>
            `;
        });

    } catch (error) {
        console.error("Error cargando citas:", error);
    }
}
cargarCitas();
</script>

<script>async function cancelarCita(id) {

    if (!confirm("¿Deseas cancelar esta cita?")) return;

    try {
        const resp = await fetch(`/api/citas/cancelar/${id}`, { method: "PUT" });

        if (!resp.ok) {
            const data = await resp.json();
            alert(data.error);
            return;
        }

        alert("Cita cancelada con éxito");
        cargarCitas();

    } catch (error) {
        alert("Error al cancelar la cita");
    }
}</script>



<!-- SCRIPT: MENU USUARIO -->
<script>
const btnMenuUsuario = document.getElementById('btnMenuUsuario');
const menuDropdown = document.getElementById('menuDropdown');

btnMenuUsuario.addEventListener('click', () => {
    menuDropdown.classList.toggle('show');
    const icon = btnMenuUsuario.querySelector('i');
    icon.classList.toggle('fa-bars');
    icon.classList.toggle('fa-xmark');
});

document.addEventListener('click', (e) => {
    if (!menuDropdown.contains(e.target) && !btnMenuUsuario.contains(e.target)) {
        menuDropdown.classList.remove('show');
        const icon = btnMenuUsuario.querySelector('i');
        icon.classList.add('fa-bars');
        icon.classList.remove('fa-xmark');
    }
});
</script>
<script>
    function estadoTextoCliente(estado) {
    switch ((estado ?? "").toUpperCase()) {
        case "REGISTRADA": return "Registrada";
        case "CANCELADA": return "Cancelada";
        case "FINALIZADA": return "Finalizada";
        default: return estado;
    }
}

</script>

</body>
</html>
